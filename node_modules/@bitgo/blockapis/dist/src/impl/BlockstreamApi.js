"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BlockstreamApi = void 0;
const bitgo_1 = require("@bitgo/utxo-lib/dist/src/bitgo");
const BaseHttpClient_1 = require("../BaseHttpClient");
const ApiBuilder_1 = require("../ApiBuilder");
function toBitGoUnspent(u, address, value) {
    return {
        id: bitgo_1.formatOutputId(u),
        address,
        value,
    };
}
class BlockstreamApi {
    constructor(client) {
        this.client = client;
    }
    static forCoin(coinName, params = {}) {
        const { httpClient = new BaseHttpClient_1.BaseHttpClient() } = params;
        switch (coinName) {
            case 'btc':
                return new BlockstreamApi(httpClient.withBaseUrl('https://blockstream.info/api'));
            case 'tbtc':
                return new BlockstreamApi(httpClient.withBaseUrl('https://blockstream.info/testnet/api'));
        }
        throw new ApiBuilder_1.ApiNotImplementedError(coinName);
    }
    async getAddressInfo(address) {
        const response = await this.client.get(`/address/${address}`);
        return response.map((body) => {
            return {
                txCount: body.chain_stats.tx_count,
                balance: body.chain_stats.funded_txo_sum - body.chain_stats.spent_txo_sum,
            };
        });
    }
    async getUnspentsForAddresses(addrs) {
        if (addrs.length !== 1) {
            return (await BaseHttpClient_1.mapSeries(addrs, (a) => this.getUnspentsForAddresses([a]))).flat();
        }
        const [address] = addrs;
        return (await this.client.get(`/address/${address}/utxo`)).map((unspents) => unspents.map((u) => toBitGoUnspent(u, address, u.value)));
    }
    async getTransactionHex(txid) {
        return (await this.client.get(`/tx/${txid}/hex`)).map((v) => v);
    }
    async getTransactionStatus(txid) {
        try {
            return (await this.client.get(`/tx/${txid}`)).map(({ status }) => status.confirmed
                ? { found: true, confirmed: true, blockHeight: status.block_height, blockHash: status.block_hash }
                : { found: true, confirmed: false });
        }
        catch (e) {
            if (e instanceof BaseHttpClient_1.ApiRequestError) {
                const reason = e.reason;
                if (reason.response.status === 404 && reason.response.text === 'Transaction not found') {
                    return { found: false };
                }
            }
            throw e;
        }
    }
    async getTransactionInputs(txid) {
        return (await this.client.get(`/tx/${txid}`)).map((body) => body.vin.map((u) => toBitGoUnspent(u, u.prevout.scriptpubkey_address, u.prevout.value)));
    }
    async getTransactionSpends(txid) {
        return (await this.client.get(`/tx/${txid}/outspends`)).map((arr) => arr.map((v) => (v.txid ? { txid: v.txid, vin: v.vin } : { txid: undefined, vin: undefined })));
    }
}
exports.BlockstreamApi = BlockstreamApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tzdHJlYW1BcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW1wbC9CbG9ja3N0cmVhbUFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBeUU7QUFHekUsc0RBQTJGO0FBQzNGLDhDQUF1RDtBQXVDdkQsU0FBUyxjQUFjLENBQUMsQ0FBYSxFQUFFLE9BQWUsRUFBRSxLQUFhO0lBQ25FLE9BQU87UUFDTCxFQUFFLEVBQUUsc0JBQWMsQ0FBQyxDQUFDLENBQUM7UUFDckIsT0FBTztRQUNQLEtBQUs7S0FDTixDQUFDO0FBQ0osQ0FBQztBQW9CRCxNQUFhLGNBQWM7SUFhekIsWUFBbUIsTUFBa0I7UUFBbEIsV0FBTSxHQUFOLE1BQU0sQ0FBWTtJQUFHLENBQUM7SUFaekMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFNBQXNDLEVBQUU7UUFDdkUsTUFBTSxFQUFFLFVBQVUsR0FBRyxJQUFJLCtCQUFjLEVBQUUsRUFBRSxHQUFHLE1BQU0sQ0FBQztRQUNyRCxRQUFRLFFBQVEsRUFBRTtZQUNoQixLQUFLLEtBQUs7Z0JBQ1IsT0FBTyxJQUFJLGNBQWMsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLDhCQUE4QixDQUFDLENBQUMsQ0FBQztZQUNwRixLQUFLLE1BQU07Z0JBQ1QsT0FBTyxJQUFJLGNBQWMsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLHNDQUFzQyxDQUFDLENBQUMsQ0FBQztTQUM3RjtRQUVELE1BQU0sSUFBSSxtQ0FBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBSUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFlO1FBQ2xDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQWlCLFlBQVksT0FBTyxFQUFFLENBQUMsQ0FBQztRQUM5RSxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMz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QUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQVk7UUFDckMsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQW9CLE9BQU8sSUFBSSxZQUFZLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQ3JGLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FDOUYsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXRFRCx3Q0FzRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmb3JtYXRPdXRwdXRJZCwgVW5zcGVudCB9IGZyb20gJ0BiaXRnby91dHhvLWxpYi9kaXN0L3NyYy9iaXRnbyc7XG5pbXBvcnQgeyBBZGRyZXNzQXBpLCBBZGRyZXNzSW5mbyB9IGZyb20gJy4uL0FkZHJlc3NBcGknO1xuaW1wb3J0IHsgT3V0cHV0U3BlbmQsIFV0eG9BcGkgfSBmcm9tICcuLi9VdHhvQXBpJztcbmltcG9ydCB7IEFwaVJlcXVlc3RFcnJvciwgQmFzZUh0dHBDbGllbnQsIEh0dHBDbGllbnQsIG1hcFNlcmllcyB9IGZyb20gJy4uL0Jhc2VIdHRwQ2xpZW50JztcbmltcG9ydCB7IEFwaU5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tICcuLi9BcGlCdWlsZGVyJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uU3RhdHVzIH0gZnJvbSAnLi4vVHJhbnNhY3Rpb25BcGknO1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vQmxvY2tzdHJlYW0vZXNwbG9yYS9ibG9iL21hc3Rlci9BUEkubWQjZ2V0LWFkZHJlc3NhZGRyZXNzXG50eXBlIEVzcGxvcmFBZGRyZXNzU3RhdHMgPSB7XG4gIHR4X2NvdW50OiBudW1iZXI7XG4gIGZ1bmRlZF90eG9fc3VtOiBudW1iZXI7XG4gIHNwZW50X3R4b19zdW06IG51bWJlcjtcbn07XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9CbG9ja3N0cmVhbS9lc3Bsb3JhL2Jsb2IvbWFzdGVyL0FQSS5tZCNnZXQtYWRkcmVzc2FkZHJlc3NcbnR5cGUgRXNwbG9yYUFkZHJlc3MgPSB7XG4gIGFkZHJlc3M6IHN0cmluZztcbiAgY2hhaW5fc3RhdHM6IEVzcGxvcmFBZGRyZXNzU3RhdHM7XG4gIG1lbXBvb2xfc3RhYXRzOiBFc3Bsb3JhQWRkcmVzc1N0YXRzO1xufTtcblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL0Jsb2Nrc3RyZWFtL2VzcGxvcmEvYmxvYi9tYXN0ZXIvQVBJLm1kI2dldC1hZGRyZXNzYWRkcmVzc3V0eG9cbnR5cGUgRXNwbG9yYVZpbiA9IHtcbiAgdHhpZDogc3RyaW5nO1xuICB2b3V0OiBudW1iZXI7XG4gIHN0YXR1czogdW5rbm93bjtcbiAgdmFsdWU6IG51bWJlcjtcbiAgcHJldm91dDogRXNwbG9yYVZvdXQ7XG59O1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vQmxvY2tzdHJlYW0vZXNwbG9yYS9ibG9iL21hc3Rlci9BUEkubWQjZ2V0LWFkZHJlc3NhZGRyZXNzdXR4b1xudHlwZSBFc3Bsb3JhVm91dCA9IHtcbiAgc2NyaXB0cHVia2V5OiBzdHJpbmc7XG4gIHNjcmlwdHB1YmtleV9hZGRyZXNzOiBzdHJpbmc7XG4gIHZhbHVlOiBudW1iZXI7XG59O1xuXG4vLyBodHRwczovL2dpdGh1Yi5jb20vQmxvY2tzdHJlYW0vZXNwbG9yYS9ibG9iL21hc3Rlci9BUEkubWQjZ2V0LXR4dHhpZG91dHNwZW5kdm91dFxudHlwZSBFc3Bsb3JhT3V0c3BlbmQgPSB7XG4gIHR4aWQ6IHN0cmluZztcbiAgdmluOiBudW1iZXI7XG59O1xuXG5mdW5jdGlvbiB0b0JpdEdvVW5zcGVudCh1OiBFc3Bsb3JhVmluLCBhZGRyZXNzOiBzdHJpbmcsIHZhbHVlOiBudW1iZXIpOiBVbnNwZW50IHtcbiAgcmV0dXJuIHtcbiAgICBpZDogZm9ybWF0T3V0cHV0SWQodSksXG4gICAgYWRkcmVzcyxcbiAgICB2YWx1ZSxcbiAgfTtcbn1cblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL0Jsb2Nrc3RyZWFtL2VzcGxvcmEvYmxvYi9tYXN0ZXIvQVBJLm1kI2dldC10eHR4aWRzdGF0dXNcbnR5cGUgRXNwbG9yYVN0YXR1cyA9XG4gIHwge1xuICAgICAgY29uZmlybWVkOiBmYWxzZTtcbiAgICB9XG4gIHwge1xuICAgICAgY29uZmlybWVkOiB0cnVlO1xuICAgICAgYmxvY2tfaGVpZ2h0OiBudW1iZXI7XG4gICAgICBibG9ja19oYXNoOiBzdHJpbmc7XG4gICAgfTtcblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL0Jsb2Nrc3RyZWFtL2VzcGxvcmEvYmxvYi9tYXN0ZXIvQVBJLm1kI2dldC10eHR4aWRcbnR5cGUgRXNwbG9yYVRyYW5zYWN0aW9uID0ge1xuICB0eGlkOiBzdHJpbmc7XG4gIHZpbjogRXNwbG9yYVZpbltdO1xuICBzdGF0dXM6IEVzcGxvcmFTdGF0dXM7XG59O1xuXG5leHBvcnQgY2xhc3MgQmxvY2tzdHJlYW1BcGkgaW1wbGVtZW50cyBBZGRyZXNzQXBpLCBVdHhvQXBpIHtcbiAgc3RhdGljIGZvckNvaW4oY29pbk5hbWU6IHN0cmluZywgcGFyYW1zOiB7IGh0dHBDbGllbnQ/OiBIdHRwQ2xpZW50IH0gPSB7fSk6IEJsb2Nrc3RyZWFtQXBpIHtcbiAgICBjb25zdCB7IGh0dHBDbGllbnQgPSBuZXcgQmFzZUh0dHBDbGllbnQoKSB9ID0gcGFyYW1zO1xuICAgIHN3aXRjaCAoY29pbk5hbWUpIHtcbiAgICAgIGNhc2UgJ2J0Yyc6XG4gICAgICAgIHJldHVybiBuZXcgQmxvY2tzdHJlYW1BcGkoaHR0cENsaWVudC53aXRoQmFzZVVybCgnaHR0cHM6Ly9ibG9ja3N0cmVhbS5pbmZvL2FwaScpKTtcbiAgICAgIGNhc2UgJ3RidGMnOlxuICAgICAgICByZXR1cm4gbmV3IEJsb2Nrc3RyZWFtQXBpKGh0dHBDbGllbnQud2l0aEJhc2VVcmwoJ2h0dHBzOi8vYmxvY2tzdHJlYW0uaW5mby90ZXN0bmV0L2FwaScpKTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgQXBpTm90SW1wbGVtZW50ZWRFcnJvcihjb2luTmFtZSk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgY2xpZW50OiBIdHRwQ2xpZW50KSB7fVxuXG4gIGFzeW5jIGdldEFkZHJlc3NJbmZvKGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWRkcmVzc0luZm8+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LmdldDxFc3Bsb3JhQWRkcmVzcz4oYC9hZGRyZXNzLyR7YWRkcmVzc31gKTtcbiAgICByZXR1cm4gcmVzcG9uc2UubWFwKChib2R5KSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0eENvdW50OiBib2R5LmNoYWluX3N0YXRzLnR4X2NvdW50LFxuICAgICAgICBiYWxhbmNlOiBib2R5LmNoYWluX3N0YXRzLmZ1bmRlZF90eG9fc3VtIC0gYm9keS5jaGFpbl9zdGF0cy5zcGVudF90eG9fc3VtLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFVuc3BlbnRzRm9yQWRkcmVzc2VzKGFkZHJzOiBzdHJpbmdbXSk6IFByb21pc2U8VW5zcGVudFtdPiB7XG4gICAgaWYgKGFkZHJzLmxlbmd0aCAhPT0gMSkge1xuICAgICAgcmV0dXJuIChhd2FpdCBtYXBTZXJpZXMoYWRkcnMsIChhKSA9PiB0aGlzLmdldFVuc3BlbnRzRm9yQWRkcmVzc2VzKFthXSkpKS5mbGF0KCk7XG4gICAgfVxuXG4gICAgY29uc3QgW2FkZHJlc3NdID0gYWRkcnM7XG5cbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuY2xpZW50LmdldDxFc3Bsb3JhVmluW10+KGAvYWRkcmVzcy8ke2FkZHJlc3N9L3V0eG9gKSkubWFwKCh1bnNwZW50cykgPT5cbiAgICAgIHVuc3BlbnRzLm1hcCgodSkgPT4gdG9CaXRHb1Vuc3BlbnQodSwgYWRkcmVzcywgdS52YWx1ZSkpXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uSGV4KHR4aWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmNsaWVudC5nZXQ8c3RyaW5nPihgL3R4LyR7dHhpZH0vaGV4YCkpLm1hcCgodikgPT4gdik7XG4gIH1cblxuICBhc3luYyBnZXRUcmFuc2FjdGlvblN0YXR1cyh0eGlkOiBzdHJpbmcpOiBQcm9taXNlPFRyYW5zYWN0aW9uU3RhdHVzPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5jbGllbnQuZ2V0PEVzcGxvcmFUcmFuc2FjdGlvbj4oYC90eC8ke3R4aWR9YCkpLm1hcCgoeyBzdGF0dXMgfSkgPT5cbiAgICAgICAgc3RhdHVzLmNvbmZpcm1lZFxuICAgICAgICAgID8geyBmb3VuZDogdHJ1ZSwgY29uZmlybWVkOiB0cnVlLCBibG9ja0hlaWdodDogc3RhdHVzLmJsb2NrX2hlaWdodCwgYmxvY2tIYXNoOiBzdGF0dXMuYmxvY2tfaGFzaCB9XG4gICAgICAgICAgOiB7IGZvdW5kOiB0cnVlLCBjb25maXJtZWQ6IGZhbHNlIH1cbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBBcGlSZXF1ZXN0RXJyb3IpIHtcbiAgICAgICAgY29uc3QgcmVhc29uID0gZS5yZWFzb24gYXMgYW55O1xuICAgICAgICBpZiAocmVhc29uLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0ICYmIHJlYXNvbi5yZXNwb25zZS50ZXh0ID09PSAnVHJhbnNhY3Rpb24gbm90IGZvdW5kJykge1xuICAgICAgICAgIHJldHVybiB7IGZvdW5kOiBmYWxzZSB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uSW5wdXRzKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8VW5zcGVudFtdPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmNsaWVudC5nZXQ8RXNwbG9yYVRyYW5zYWN0aW9uPihgL3R4LyR7dHhpZH1gKSkubWFwKChib2R5KSA9PlxuICAgICAgYm9keS52aW4ubWFwKCh1KSA9PiB0b0JpdEdvVW5zcGVudCh1LCB1LnByZXZvdXQuc2NyaXB0cHVia2V5X2FkZHJlc3MsIHUucHJldm91dC52YWx1ZSkpXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uU3BlbmRzKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8T3V0cHV0U3BlbmRbXT4ge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5jbGllbnQuZ2V0PEVzcGxvcmFPdXRzcGVuZFtdPihgL3R4LyR7dHhpZH0vb3V0c3BlbmRzYCkpLm1hcCgoYXJyKSA9PlxuICAgICAgYXJyLm1hcCgodikgPT4gKHYudHhpZCA/IHsgdHhpZDogdi50eGlkLCB2aW46IHYudmluIH0gOiB7IHR4aWQ6IHVuZGVmaW5lZCwgdmluOiB1bmRlZmluZWQgfSkpXG4gICAgKTtcbiAgfVxufVxuIl19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BlockchairApi = void 0;
const bitgo_1 = require("@bitgo/utxo-lib/dist/src/bitgo");
const BaseHttpClient_1 = require("../BaseHttpClient");
const ApiBuilder_1 = require("../ApiBuilder");
class ErrorKeyNotInResponse extends Error {
    constructor(key) {
        super(`key ${key} not in response`);
    }
}
function unwrapRecord(body, key) {
    if (!(key in body.data)) {
        throw new ErrorKeyNotInResponse(key);
    }
    return body.data[key];
}
class BlockchairApi {
    constructor(client, apiToken) {
        this.client = client;
        this.apiToken = apiToken !== null && apiToken !== void 0 ? apiToken : process.env.BLOCKCHAIR_TOKEN;
    }
    static forCoin(coinName, params = {}) {
        // https://blockchair.com/api/docs#link_M0
        let blockchain;
        switch (coinName) {
            case 'btc':
                blockchain = 'bitcoin';
                break;
            case 'tbtc':
                blockchain = 'bitcoin/testnet';
                break;
            case 'bsv':
                blockchain = 'bitcoin-sv';
                break;
            case 'bch':
                blockchain = 'bitcoin-cash';
                break;
            case 'bcha':
                blockchain = 'ecash';
                break;
            case 'ltc':
                blockchain = 'litecoin';
                break;
            case 'dash':
                blockchain = 'dash';
                break;
            case 'zec':
                blockchain = 'zcash';
                break;
            default:
                throw new ApiBuilder_1.ApiNotImplementedError(coinName);
        }
        const { httpClient = new BaseHttpClient_1.BaseHttpClient() } = params;
        return new BlockchairApi(httpClient.withBaseUrl(`https://api.blockchair.com/${blockchain}`), params.apiToken);
    }
    get(path) {
        return this.client.get(path + (this.apiToken ? `?key=${this.apiToken}` : ''));
    }
    async getAddressInfo(address) {
        if (!address || address.length === 0) {
            throw new Error('invalid address');
        }
        // https://blockchair.com/api/docs#link_300
        return (await this.get(`/dashboards/address/${address}`)).map((body) => {
            return {
                txCount: body.data[address].address.transaction_count,
                balance: body.data[address].address.balance,
            };
        });
    }
    async getUnspentsForAddresses(addr) {
        if (addr.length > 100) {
            throw new Error(`invalid size`);
        }
        // https://blockchair.com/api/docs#link_300
        return (await this.get(`/dashboards/addresses/${addr.join(',')}`)).map((body) => {
            return addr.flatMap((a) => {
                return body.data.utxo.map((unspent) => {
                    return {
                        id: bitgo_1.formatOutputId({ txid: unspent.transaction_hash, vout: unspent.index }),
                        address: a,
                        value: unspent.value,
                    };
                });
            });
        });
    }
    async getTransaction(txid) {
        return (await this.get(`/dashboards/transaction/${txid}`)).map((body) => {
            return unwrapRecord(body, txid);
        });
    }
    async getTransactionStatus(txid) {
        let transaction;
        try {
            transaction = (await this.getTransaction(txid)).transaction;
        }
        catch (e) {
            if (e instanceof ErrorKeyNotInResponse) {
                return { found: false };
            }
            throw e;
        }
        const { block_id, time } = transaction;
        const date = new Date(Date.parse(time.replace(' ', 'T') + '.000Z' /* force UTC parsing */));
        return block_id === -1
            ? { found: true, confirmed: false }
            : {
                found: true,
                confirmed: true,
                blockHeight: block_id,
                date,
            };
    }
    async getTransactionInputs(txid) {
        return (await this.getTransaction(txid)).inputs.map((i) => {
            return {
                id: bitgo_1.formatOutputId({ txid: i.transaction_hash, vout: i.index }),
                address: i.recipient,
                value: i.value,
            };
        });
    }
    async getTransactionSpends(txid) {
        return (await this.getTransaction(txid)).outputs.map((o) => o.spending_transaction_hash
            ? {
                txid: o.spending_transaction_hash,
                vin: o.spending_index,
            }
            : { txid: undefined, vin: undefined });
    }
    async getTransactionHex(txid) {
        return (await this.get(`/raw/transaction/${txid}`)).map((body) => {
            return unwrapRecord(body, txid).raw_transaction;
        });
    }
}
exports.BlockchairApi = BlockchairApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tjaGFpckFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbXBsL0Jsb2NrY2hhaXJBcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMERBQXlFO0FBRXpFLHNEQUF5RTtBQUN6RSw4Q0FBdUQ7QUFXdkQsTUFBTSxxQkFBc0IsU0FBUSxLQUFLO0lBQ3ZDLFlBQVksR0FBVztRQUNyQixLQUFLLENBQUMsT0FBTyxHQUFHLGtCQUFrQixDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGO0FBRUQsU0FBUyxZQUFZLENBQUksSUFBaUMsRUFBRSxHQUFXO0lBQ3JFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDdkIsTUFBTSxJQUFJLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ3RDO0lBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFtREQsTUFBYSxhQUFhO0lBc0N4QixZQUFtQixNQUFrQixFQUFFLFFBQWlCO1FBQXJDLFdBQU0sR0FBTixNQUFNLENBQVk7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLGFBQVIsUUFBUSxjQUFSLFFBQVEsR0FBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO0lBQzNELENBQUM7SUFyQ0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFNBQXlELEVBQUU7UUFDMUYsMENBQTBDO1FBQzFDLElBQUksVUFBVSxDQUFDO1FBQ2YsUUFBUSxRQUFRLEVBQUU7WUFDaEIsS0FBSyxLQUFLO2dCQUNSLFVBQVUsR0FBRyxTQUFTLENBQUM7Z0JBQ3ZCLE1BQU07WUFDUixLQUFLLE1BQU07Z0JBQ1QsVUFBVSxHQUFHLGlCQUFpQixDQUFDO2dCQUMvQixNQUFNO1lBQ1IsS0FBSyxLQUFLO2dCQUNSLFVBQVUsR0FBRyxZQUFZLENBQUM7Z0JBQzFCLE1B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QU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUN4RCxPQUFPO2dCQUNMLEVBQUUsRUFBRSxzQkFBYyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUMvRCxPQUFPLEVBQUUsQ0FBQyxDQUFDLFNBQVM7Z0JBQ3BCLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSzthQUNmLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsb0JBQW9CLENBQUMsSUFBWTtRQUNyQyxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ3pELENBQUMsQ0FBQyx5QkFBeUI7WUFDekIsQ0FBQyxDQUFDO2dCQUNFLElBQUksRUFBRSxDQUFDLENBQUMseUJBQXlCO2dCQUNqQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLGNBQWM7YUFDdEI7WUFDSCxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FDeEMsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsaUJBQWlCLENBQUMsSUFBWTtRQUNsQyxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFxRCxvQkFBb0IsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FDekcsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNQLE9BQU8sWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxlQUFlLENBQUM7UUFDbEQsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUEzSUQsc0NBMklDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0T3V0cHV0SWQsIFVuc3BlbnQgfSBmcm9tICdAYml0Z28vdXR4by1saWIvZGlzdC9zcmMvYml0Z28nO1xuXG5pbXBvcnQgeyBCYXNlSHR0cENsaWVudCwgSHR0cENsaWVudCwgUmVzcG9uc2UgfSBmcm9tICcuLi9CYXNlSHR0cENsaWVudCc7XG5pbXBvcnQgeyBBcGlOb3RJbXBsZW1lbnRlZEVycm9yIH0gZnJvbSAnLi4vQXBpQnVpbGRlcic7XG5pbXBvcnQgeyBBZGRyZXNzQXBpLCBBZGRyZXNzSW5mbyB9IGZyb20gJy4uL0FkZHJlc3NBcGknO1xuaW1wb3J0IHsgT3V0cHV0U3BlbmQsIFV0eG9BcGkgfSBmcm9tICcuLi9VdHhvQXBpJztcbmltcG9ydCB7IFRyYW5zYWN0aW9uU3RhdHVzIH0gZnJvbSAnLi4vVHJhbnNhY3Rpb25BcGknO1xuXG50eXBlIEJsb2NrY2hhaXJSZXNwb25zZTxUPiA9IHtcbiAgZGF0YTogVDtcbn07XG5cbnR5cGUgQmxvY2tjaGFpclJlY29yZFJlc3BvbnNlPFQ+ID0gQmxvY2tjaGFpclJlc3BvbnNlPFJlY29yZDxzdHJpbmcsIFQ+PjtcblxuY2xhc3MgRXJyb3JLZXlOb3RJblJlc3BvbnNlIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihrZXk6IHN0cmluZykge1xuICAgIHN1cGVyKGBrZXkgJHtrZXl9IG5vdCBpbiByZXNwb25zZWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHVud3JhcFJlY29yZDxUPihib2R5OiBCbG9ja2NoYWlyUmVjb3JkUmVzcG9uc2U8VD4sIGtleTogc3RyaW5nKTogVCB7XG4gIGlmICghKGtleSBpbiBib2R5LmRhdGEpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yS2V5Tm90SW5SZXNwb25zZShrZXkpO1xuICB9XG4gIHJldHVybiBib2R5LmRhdGFba2V5XTtcbn1cblxuLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rXzMwMFxudHlwZSBCbG9ja2NoYWlyVW5zcGVudCA9IHtcbiAgdHJhbnNhY3Rpb25faGFzaDogc3RyaW5nO1xuICBpbmRleDogbnVtYmVyO1xuICByZWNpcGllbnQ6IHN0cmluZztcbiAgdmFsdWU6IG51bWJlcjtcbiAgYmxvY2tfaWQ6IG51bWJlcjtcbiAgc2NyaXB0X2hleDogc3RyaW5nO1xuICBzcGVuZGluZ190cmFuc2FjdGlvbl9oYXNoOiBzdHJpbmc7XG4gIHNwZW5kaW5nX2luZGV4OiBudW1iZXI7XG59O1xuXG4vLyBodHRwczovL2Jsb2NrY2hhaXIuY29tL2FwaS9kb2NzI2xpbmtfMzAwXG50eXBlIEJsb2NrY2hhaXJBZGRyZXNzID0ge1xuICBhZGRyZXNzOiB7XG4gICAgdHJhbnNhY3Rpb25faGFzaDogc3RyaW5nO1xuICAgIC8vIHZvdXRcbiAgICBpbmRleDogbnVtYmVyO1xuICAgIHZhbHVlOiBudW1iZXI7XG4gICAgYmxvY2tfaWQ6IG51bWJlcjtcbiAgICB0cmFuc2FjdGlvbl9jb3VudDogbnVtYmVyO1xuICAgIGJhbGFuY2U6IG51bWJlcjtcbiAgfTtcbiAgdXR4bzogQmxvY2tjaGFpclVuc3BlbnRbXTtcbn07XG5cbi8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18yMDBcbnR5cGUgQmxvY2tjaGFpclRyYW5zYWN0aW9uID0ge1xuICB0cmFuc2FjdGlvbjoge1xuICAgIC8qKlxuICAgICAgVGhlIGJsb2NrIG51bWJlciBpdCdzIGluY2x1ZGVkIGluLlxuICAgICAgSWYgdGhlIHRyYW5zYWN0aW9uIGlzIGluIHRoZSBtZW1wb29sLCBkYXRhLns6aGFzaH3htaIudHJhbnNhY3Rpb24uYmxvY2tfaWQgeWllbGRzIC0xXG4gICAgKi9cbiAgICBibG9ja19pZDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIExpa2UgaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1kYXRlLXRpbWUtc3RyaW5nLWZvcm1hdCBidXQgd2l0aCBhIHNwYWNlIGluc3RlYWQgb2YgJ1QnXG4gICAgICogWVlZWS1NTS1ERCBISDptbTpzc1xuICAgICAqL1xuICAgIHRpbWU6IHN0cmluZztcbiAgfTtcbiAgaW5wdXRzOiBCbG9ja2NoYWlyVW5zcGVudFtdO1xuICBvdXRwdXRzOiBCbG9ja2NoYWlyVW5zcGVudFtdO1xufTtcblxuLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rXzIwMVxudHlwZSBCbG9ja2NoYWlyUmF3VHJhbnNhY3Rpb24gPSB7XG4gIHJhd190cmFuc2FjdGlvbjogc3RyaW5nO1xufTtcblxuZXhwb3J0IGNsYXNzIEJsb2NrY2hhaXJBcGkgaW1wbGVtZW50cyBBZGRyZXNzQXBpLCBVdHhvQXBpIHtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGFwaVRva2VuPzogc3RyaW5nO1xuXG4gIHN0YXRpYyBmb3JDb2luKGNvaW5OYW1lOiBzdHJpbmcsIHBhcmFtczogeyBhcGlUb2tlbj86IHN0cmluZzsgaHR0cENsaWVudD86IEh0dHBDbGllbnQgfSA9IHt9KTogQmxvY2tjaGFpckFwaSB7XG4gICAgLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rX00wXG4gICAgbGV0IGJsb2NrY2hhaW47XG4gICAgc3dpdGNoIChjb2luTmFtZSkge1xuICAgICAgY2FzZSAnYnRjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0YnRjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luL3Rlc3RuZXQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2Jzdic6XG4gICAgICAgIGJsb2NrY2hhaW4gPSAnYml0Y29pbi1zdic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnYmNoJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luLWNhc2gnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2JjaGEnOlxuICAgICAgICBibG9ja2NoYWluID0gJ2VjYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdsdGMnOlxuICAgICAgICBibG9ja2NoYWluID0gJ2xpdGVjb2luJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkYXNoJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdkYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd6ZWMnOlxuICAgICAgICBibG9ja2NoYWluID0gJ3pjYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgQXBpTm90SW1wbGVtZW50ZWRFcnJvcihjb2luTmFtZSk7XG4gICAgfVxuICAgIGNvbnN0IHsgaHR0cENsaWVudCA9IG5ldyBCYXNlSHR0cENsaWVudCgpIH0gPSBwYXJhbXM7XG4gICAgcmV0dXJuIG5ldyBCbG9ja2NoYWlyQXBpKGh0dHBDbGllbnQud2l0aEJhc2VVcmwoYGh0dHBzOi8vYXBpLmJsb2NrY2hhaXIuY29tLyR7YmxvY2tjaGFpbn1gKSwgcGFyYW1zLmFwaVRva2VuKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBjbGllbnQ6IEh0dHBDbGllbnQsIGFwaVRva2VuPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hcGlUb2tlbiA9IGFwaVRva2VuID8/IHByb2Nlc3MuZW52LkJMT0NLQ0hBSVJfVE9LRU47XG4gIH1cblxuICBnZXQ8VD4ocGF0aDogc3RyaW5nKTogUHJvbWlzZTxSZXNwb25zZTxUPj4ge1xuICAgIHJldHVybiB0aGlzLmNsaWVudC5nZXQocGF0aCArICh0aGlzLmFwaVRva2VuID8gYD9rZXk9JHt0aGlzLmFwaVRva2VufWAgOiAnJykpO1xuICB9XG5cbiAgYXN5bmMgZ2V0QWRkcmVzc0luZm8oYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxBZGRyZXNzSW5mbz4ge1xuICAgIGlmICghYWRkcmVzcyB8fCBhZGRyZXNzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIGFkZHJlc3MnKTtcbiAgICB9XG4gICAgLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rXzMwMFxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXQ8QmxvY2tjaGFpclJlY29yZFJlc3BvbnNlPEJsb2NrY2hhaXJBZGRyZXNzPj4oYC9kYXNoYm9hcmRzL2FkZHJlc3MvJHthZGRyZXNzfWApKS5tYXAoXG4gICAgICAoYm9keSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHR4Q291bnQ6IGJvZHkuZGF0YVthZGRyZXNzXS5hZGRyZXNzLnRyYW5zYWN0aW9uX2NvdW50LFxuICAgICAgICAgIGJhbGFuY2U6IGJvZHkuZGF0YVthZGRyZXNzXS5hZGRyZXNzLmJhbGFuY2UsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFVuc3BlbnRzRm9yQWRkcmVzc2VzKGFkZHI6IHN0cmluZ1tdKTogUHJvbWlzZTxVbnNwZW50W10+IHtcbiAgICBpZiAoYWRkci5sZW5ndGggPiAxMDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBzaXplYCk7XG4gICAgfVxuICAgIC8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18zMDBcbiAgICByZXR1cm4gKFxuICAgICAgYXdhaXQgdGhpcy5nZXQ8QmxvY2tjaGFpclJlc3BvbnNlPHsgdXR4bzogQmxvY2tjaGFpclVuc3BlbnRbXSB9Pj4oYC9kYXNoYm9hcmRzL2FkZHJlc3Nlcy8ke2FkZHIuam9pbignLCcpfWApXG4gICAgKS5tYXAoKGJvZHkpID0+IHtcbiAgICAgIHJldHVybiBhZGRyLmZsYXRNYXAoKGEpID0+IHtcbiAgICAgICAgcmV0dXJuIGJvZHkuZGF0YS51dHhvLm1hcCgodW5zcGVudCk6IFVuc3BlbnQgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogZm9ybWF0T3V0cHV0SWQoeyB0eGlkOiB1bnNwZW50LnRyYW5zYWN0aW9uX2hhc2gsIHZvdXQ6IHVuc3BlbnQuaW5kZXggfSksXG4gICAgICAgICAgICBhZGRyZXNzOiBhLFxuICAgICAgICAgICAgdmFsdWU6IHVuc3BlbnQudmFsdWUsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8QmxvY2tjaGFpclRyYW5zYWN0aW9uPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldDxCbG9ja2NoYWlyUmVjb3JkUmVzcG9uc2U8QmxvY2tjaGFpclRyYW5zYWN0aW9uPj4oYC9kYXNoYm9hcmRzL3RyYW5zYWN0aW9uLyR7dHhpZH1gKSkubWFwKFxuICAgICAgKGJvZHkpID0+IHtcbiAgICAgICAgcmV0dXJuIHVud3JhcFJlY29yZChib2R5LCB0eGlkKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25TdGF0dXModHhpZDogc3RyaW5nKTogUHJvbWlzZTxUcmFuc2FjdGlvblN0YXR1cz4ge1xuICAgIGxldCB0cmFuc2FjdGlvbjtcbiAgICB0cnkge1xuICAgICAgdHJhbnNhY3Rpb24gPSAoYXdhaXQgdGhpcy5nZXRUcmFuc2FjdGlvbih0eGlkKSkudHJhbnNhY3Rpb247XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBFcnJvcktleU5vdEluUmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHsgZm91bmQ6IGZhbHNlIH07XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICBjb25zdCB7IGJsb2NrX2lkLCB0aW1lIH0gPSB0cmFuc2FjdGlvbjtcbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoRGF0ZS5wYXJzZSh0aW1lLnJlcGxhY2UoJyAnLCAnVCcpICsgJy4wMDBaJyAvKiBmb3JjZSBVVEMgcGFyc2luZyAqLykpO1xuICAgIHJldHVybiBibG9ja19pZCA9PT0gLTFcbiAgICAgID8geyBmb3VuZDogdHJ1ZSwgY29uZmlybWVkOiBmYWxzZSB9XG4gICAgICA6IHtcbiAgICAgICAgICBmb3VuZDogdHJ1ZSxcbiAgICAgICAgICBjb25maXJtZWQ6IHRydWUsXG4gICAgICAgICAgYmxvY2tIZWlnaHQ6IGJsb2NrX2lkLFxuICAgICAgICAgIGRhdGUsXG4gICAgICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRUcmFuc2FjdGlvbklucHV0cyh0eGlkOiBzdHJpbmcpOiBQcm9taXNlPFVuc3BlbnRbXT4ge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXRUcmFuc2FjdGlvbih0eGlkKSkuaW5wdXRzLm1hcCgoaSkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IGZvcm1hdE91dHB1dElkKHsgdHhpZDogaS50cmFuc2FjdGlvbl9oYXNoLCB2b3V0OiBpLmluZGV4IH0pLFxuICAgICAgICBhZGRyZXNzOiBpLnJlY2lwaWVudCxcbiAgICAgICAgdmFsdWU6IGkudmFsdWUsXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25TcGVuZHModHhpZDogc3RyaW5nKTogUHJvbWlzZTxPdXRwdXRTcGVuZFtdPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldFRyYW5zYWN0aW9uKHR4aWQpKS5vdXRwdXRzLm1hcCgobykgPT5cbiAgICAgIG8uc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaFxuICAgICAgICA/IHtcbiAgICAgICAgICAgIHR4aWQ6IG8uc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaCxcbiAgICAgICAgICAgIHZpbjogby5zcGVuZGluZ19pbmRleCxcbiAgICAgICAgICB9XG4gICAgICAgIDogeyB0eGlkOiB1bmRlZmluZWQsIHZpbjogdW5kZWZpbmVkIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25IZXgodHhpZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0PEJsb2NrY2hhaXJSZWNvcmRSZXNwb25zZTxCbG9ja2NoYWlyUmF3VHJhbnNhY3Rpb24+PihgL3Jhdy90cmFuc2FjdGlvbi8ke3R4aWR9YCkpLm1hcChcbiAgICAgIChib2R5KSA9PiB7XG4gICAgICAgIHJldHVybiB1bndyYXBSZWNvcmQoYm9keSwgdHhpZCkucmF3X3RyYW5zYWN0aW9uO1xuICAgICAgfVxuICAgICk7XG4gIH1cbn1cbiJdfQ==